<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jzfw.dao.extend.BaseUserExtendMapper">
  
  <select id="selectById" resultMap="BaseUserExtendResultMap">
    SELECT *
    FROM base_user
    WHERE id = #{id,jdbcType=BIGINT}
  </select>

  <select id="selectAll" resultMap="BaseUserExtendResultMap">
    SELECT *
    FROM base_user
  </select>

  <!-- <select id="query" resultMap="com.jzfw.dao.BaseUserMapper.BaseResultMap">  -->
  <select id="query" resultMap="BaseUserExtendResultMap"> 
  		SELECT u.* 
		FROM base_user as u 
		LEFT JOIN base_user_role as ur ON u.id = ur.user_id 
		Inner JOIN base_role as r ON r.id = ur.role_id
		<where>
			<if test="username != null">
				u.username like concat('%',#{username},'%')
			</if>
			<if test="roleId != null">
				AND r.id = #{roleId}
			</if>
			<if test="status != null">
				AND u.status = #{status}
			</if>
		</where>
		ORDER BY u.id DESC
		limit ${(page-1)*pageSize},${pageSize}
  </select>
  
  <select id="count" resultType="long">
  		SELECT count(*) 
		FROM base_user as u 
		LEFT JOIN base_user_role as ur ON u.id = ur.user_id 
		LEFT JOIN base_role as r ON r.id = ur.role_id
		<where>
			<if test="username != null">
				u.username like concat('%',#{username},'%')
			</if>
			<if test="roleId != null">
				AND r.id = #{roleId}
			</if>
			<if test="status != null">
				AND u.status = #{status}
			</if>
		</where>
  </select>
  <!-- 用户角色结果集 -->
  <resultMap
          id="BaseUserExtendResultMap"
          type="com.jzfw.bean.extend.BaseUserExtend"
          extends="com.jzfw.dao.BaseUserMapper.BaseResultMap">
    <collection property="roles" column="id" select="com.jzfw.dao.extend.BaseRoleExtendMapper.selectByUserId" ></collection>
  </resultMap>

	<select id="findIDCard" parameterType="String" resultType="com.jzfw.bean.BaseUser">
    SELECT *
    FROM base_user
    WHERE id_card = #{idCard,jdbcType=BIGINT}
  </select>
	<insert id="insertPeopeleAndStu" parameterType="com.jzfw.bean.BaseUser">
		<!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Aug 18 10:30:49 CST 2020.
        -->
		insert into base_user (username, password,
		telephone, realname, gender,
		birth, is_free, status,
		user_face, id_card, address,
		nation, register_time, compony_id,
		parent_id)
		values (#{username,jdbcType=VARCHAR}, #{password,jdbcType=VARCHAR},
		#{telephone,jdbcType=VARCHAR}, #{realname,jdbcType=VARCHAR}, #{gender,jdbcType=VARCHAR},
		#{birth,jdbcType=BIGINT}, #{isFree,jdbcType=VARCHAR}, #{status,jdbcType=VARCHAR},
		#{userFace,jdbcType=VARCHAR}, #{idCard,jdbcType=VARCHAR}, #{address,jdbcType=VARCHAR},
		#{nation,jdbcType=VARCHAR}, #{registerTime,jdbcType=BIGINT}, #{componyId,jdbcType=BIGINT},
		#{parentId,jdbcType=BIGINT})
		<selectKey resultType="long" keyProperty="id" order="AFTER">
			select @@identity
		</selectKey>
	</insert>
</mapper>